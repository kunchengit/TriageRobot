{% extends "layout.html" %}
{% if session.logged_in %}
<head>
{%block head%}
<link rel='stylesheet' type='text/css' href='static/css/dataTables.bootstrap.css'>
<link rel="stylesheet" type="text/css" href="static/css/jquery.dataTables.css">
<link rel="stylesheet" type="text/css" href="static/css/dataTables.colVis.css">
<script type='text/javascript' src='static/js/jquery-1.11.1.js'></script>
<script type='text/javascript' src='static/js/dataTables.bootstrap.js'></script>
<script type='text/javascript' src='static/js/bootstrap-3.1.1.js'></script>
<script type='text/javascript' src='static/js/jquery.dataTables.js'></script>
<script type='text/javascript' src='static/js/dataTables.colVis.js'></script>
<script type='text/javascript' src='static/js/dataTables.fixedColumns.js'></script>
<script type="text/javascript" src="static/js/dataTables.fnGetFilteredNodes.js"></script>
<script type="text/javascript" src="static/js/dataTables.fnGetHiddenNodes.js"></script>
<!--
When setting the name of posted variables, the name of "check_id", "comment_id" should not be assigned since I used the check_id to represent the checkboxes and comment_id to represent the comments
07/15/2014 ShinYeh
-->
<link rel="stylesheet" type="text/css" href="static/css/jquery-ui.css">
<script type='text/javascript' src='static/js/Chart.js'></script>
<script type='text/javascript' src='static/js/jquery-ui.js'></script>

<script>
/* Create an array with the values of all the input boxes in a column, parsed as numbers */
$.fn.dataTable.ext.order['dom-text-numeric'] = function  ( settings, col )
{
    return this.api().column( col, {order:'index'} ).nodes().map( function ( td, i ) {
        return $('input', td).val() * 1;
    } );
}

$.fn.dataTable.ext.order['dom-text'] = function  ( settings, col )
{
    return this.api().column( col, {order:'index'} ).nodes().map( function ( td, i ) {
        return $('input', td).val();
    } );
}
</script>


<script>
    $(function() {
        $(".search-product").autocomplete({
            source: "{{url_for("autocomplete_product")}}",
            minLength: 2
        });
    });
</script>

</style>

<script>    
var oTable;
$(document).ready(function() {
    $('#div_sidebar').fadeOut('slide',function(){});
/*
    e1 = document.getElementById("submit_button");
    e1.style.width = "90%";
    e1.style.marginLeft = 10;
*/
    $('.main').each(function(){
        this.style.width = "100%";
        this.style.marginLeft = 0;
    })

    var oTable = $('#bugs_table').DataTable({
        paging:         true, 
        "lengthMenu": [ [-1, 5, 10, 25, 50], ["All", 5, 10, 25, 50] ],
        dom: 'C<"clear">lfrtip',
        //scrollY:        "600px",
        //scrollX: true,
        "bSort":false,
        "aoColumns": [ 
            {"bVisible":true},  //Number
            {"bVisible":true},  //BugID
            {"bVisible":true,"bSearchable":false},  //Summary-short_desc
            {"bVisible":true},  //Keywords
            {"bVisible":true},  //Weights
            {"bVisible":false}, //Priority
            {"bVisible":false}, //Severity
            {"bVisible":false}, //Case count
            {"bVisible":true, "sWidth":"20%", "orderDataType": "dom-text"},  //Fix_by_x
            {"bVisible":false},  //Assigned to
            {"bVisible":true},  //ETA
            {"bVisible":false},  //Last Modified
            {"bVisible":true, "bSearchable":false},  //Highlighted Reasons
        ],
    } );

/*
    var oTable2 = $('#summary_table').DataTable({
        paging:         true,
        "lengthMenu": [ [-1, 5, 10, 25, 50], ["All", 5, 10, 25, 50] ],
        dom: 'C<"clear">lfrtip',
        //scrollY:        "600px",
        scrollX: true,
        "bSort":false,
        "aoColumns": [
            {"bVisible":true},  //Number
            {"bVisible":true},  //BugID
            {"bVisible":true},  //Summary-short_desc
        ],
    } );
*/

    /*$('form').submit( function () {

       //Loop through the TR records
       oTable.$("td").each(function(index, nRow,name){
            //Select the input from the row
            //var rowInput = $("input", nRow);
            //Select the text area from the row
            //var rowTextarea = $("textarea", nRow);

            //Add to form
            var nHidden = document.createElement( 'input' );
            nHidden.type = 'hidden';
            nHidden.name = "hidden_input_"+index+name;

            //Assuming there is one input per row
            nHidden.value = $("input", nRow).val();
            //alert(nHidden.value);
            $(".form").append( nHidden );
            console.log(nHidden);
        });
        return false;
        $(".form").submit();
        });*/
} );
</script>

<link rel="stylesheet" type="text/css" href="static/css/vis.css">
<script type="text/javascript" src="static/js/vis.js"></script>


{% endblock %}
</head>
<body>

{% block body%}

{% set pending_cnt = [] %}
{% set debugging_cnt = [] %}
{% set ready_cnt = [] %}
{% set accepted_cnt = [] %}
{% set total_cnt = [] %}
{% set people_list = [] %}
{% for entry in bugs %}
    {% if total_cnt.append(1) %} {% endif %}
    {% if entry["keywords"].find("Sprint-Accepted") >= 0 %}
        {% if accepted_cnt.append(1) %} {% endif %}
        {% if people_list.append(entry["assigned_rn"]) %} {% endif %}
        {% if people_list.append("Sprint-Accepted") %} {% endif %}
    {% elif entry["keywords"].find("sprint-ready") >= 0 %}
        {% if ready_cnt.append(1) %} {% endif %}
        {% if people_list.append(entry["assigned_rn"]) %} {% endif %}
        {% if people_list.append("sprint-ready") %} {% endif %}
    {% elif entry["keywords"].find("Debugging") >= 0 %}
        {% if debugging_cnt.append(1) %} {% endif %}
        {% if people_list.append(entry["assigned_rn"]) %} {% endif %}
        {% if people_list.append("Debugging") %} {% endif %}
    {% elif actbugids.find(entry["bug_id"]|string) >= 0 %}
        {% if pending_cnt.append(1) %} {% endif %}
        {% if people_list.append(entry["assigned_rn"]) %} {% endif %}
        {% if people_list.append("Pending") %} {% endif %}
    {% endif %}
{% endfor %}

{% set piechart = 0 %}
{% set barchart = 1 %}
{% if piechart == 1 %}
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <script type="text/javascript">
      google.load("visualization", "1", {packages:["corechart"]});
      google.setOnLoadCallback(drawChart);
      function drawChart() {
        var data = google.visualization.arrayToDataTable([
          ['Kanban State', 'Count'],
          ['Total : {{ total_cnt|length }}', {{ total_cnt|length }}],
          ['Pending : {{ pending_cnt|length }}',     {{ pending_cnt|length }}],
          ['Debugging : {{ debugging_cnt|length }}',     {{ debugging_cnt|length }}],
          ['sprint-ready : {{ ready_cnt|length }}',      {{ ready_cnt|length }}],
          ['Sprint-Accepted : {{ accepted_cnt|length }}',  {{ accepted_cnt|length }}],
        ]);

        var options = {
          backgroundColor: '#eeeeff',
          is3D: true,
          pieSliceTextStyle: {
            color: 'black',
          },
          slices: {
            0: { color: '#cccccc' },
            1: { color: '#444444' },
            2: { color: '#aaffaa' },
            3: { color: '#ffffaa' },
            4: { color: '#ffaaaa' }
          },
          legend: {textStyle: {
            color: 'black',
            fontSize: 20,
            bold: true,
            italic: false },
            position: 'bottom',
            alignment: 'center',
          }
        };

        var chart = new google.visualization.PieChart(document.getElementById('piechart_3d'));
        chart.draw(data, options);
        google.visualization.events.addListener(chart, 'click', function(targetID) {
          var tid = targetID.targetID;
          var txt = document.getElementById('bugs_table_filter');
          txt = txt.children[0].children[0];
          if (tid == "slice#1" || tid == "legendentry#1")
              txt.value = "Pending";
          else if (tid == "slice#2" || tid == "legendentry#2")
              txt.value = "Debugging";
          else if (tid == "slice#3" || tid == "legendentry#3")
              txt.value = "sprint-ready";
          else if (tid == "slice#4" || tid == "legendentry#4")
              txt.value = "Sprint-Accepted";
          else if (tid == "slice#0" || tid == "legendentry#0")
              txt.value = "";
          var table = $('#bugs_table').DataTable();
          table.search(txt.value).draw();
        });
      }
    </script>
    <div id="piechart_3d" style="width: 100%; height: 400px;"></div>
{% elif barchart == 1 %}
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <script type="text/javascript">
      google.load("visualization", "1", {packages:["corechart"]});
      google.setOnLoadCallback(drawChart);
      function drawChart() {
        var column_chart = 1;
        var data = new google.visualization.arrayToDataTable([
          ['State', 'Count', { role: 'style' }, { role: 'annotation' } ],
          ['Pending', {{pending_cnt|length}}, 'color: #444444', '{{pending_cnt|length}}'],
          ['Debuggin', {{debugging_cnt|length}}, 'color: #aaffaa', '{{debugging_cnt|length}}'],
          ['sprint-ready', {{ready_cnt|length}}, 'color: #ffffaa', '{{ready_cnt|length}}'],
          ['Sprint-Accepted', {{accepted_cnt|length}}, 'color: ffaaaa', '{{accepted_cnt|length}}'],
          //['Total', {{total_cnt|length}}, 'color: #cccccc', '{{total_cnt|length}}'],
        ]);

        var options = {
          title: "Total number of PR: {{total_cnt|length}}",
          backgroundColor: '#eeeeff',
          legend: { position: "none" },
          chartArea: {width: '30%', height: '70%'},
        };

        var chart;
        if (column_chart == 1)
            chart  = new google.visualization.ColumnChart(document.getElementById('chart_div'));
        else
            chart  = new google.visualization.BarChart(document.getElementById('chart_div'));
        chart.draw(data, options);
        google.visualization.events.addListener(chart, 'click', function(targetID) {
          var selections = [
              ["hAxis#0#label#0", "vAxis#0#label#0", "bar#0#0", "annotationtext#0#0#0", "Pending"],
              ["hAxis#0#label#1", "vAxis#0#label#1", "bar#0#1", "annotationtext#0#1#0", "Debugging"],
              ["hAxis#0#label#2", "vAxis#0#label#2", "bar#0#2", "annotationtext#0#2#0", "sprint-ready"],
              ["hAxis#0#label#3", "vAxis#0#label#3", "bar#0#3", "annotationtext#0#3#0", "Sprint-Accepted"],
              //["hAxis#0#label#4", "vAxis#0#label#4", "bar#0#4", "annotationtext#0#4#0", ""]
          ];
          var tid = targetID.targetID;
          var txtvalue = '';
          var i, j;
          for (i=0; i<selections.length; i++) {
              for (j=0; j<4; j++) {
                  if (tid == selections[i][j]) {
                     txtvalue = selections[i][4];
                     break;
                  }
              }
              if (j < 4)
                  break;
          }
          var txt = document.getElementById('bugs_table_filter');
          txt = txt.children[0].children[0];
          txt.value = txtvalue;
          var table = $('#bugs_table').DataTable();
          table.search(txt.value).draw();
        });
      }
    </script>
    <div id="chart_div" style="width: 100%; height: 300px;"></div>
{% else %}

<script>
function filter_my_table(id) {
    var txt = document.getElementById('bugs_table_filter');
    txt = txt.children[0].children[0];
    var v = id;
    txt.value = v;
    var table = $('#bugs_table').DataTable();
    table.search(txt.value).draw();
}
</script>
<table id="summary_table" align="right">
<tbody>
<tr>
    <td onclick="filter_my_table('');" style="background:#cccccc;color:black;font-weight:bold;font-size:30px;"> &nbsp;&nbsp;&nbsp;&nbsp; Total : {{ total_cnt|length }} &nbsp;&nbsp;&nbsp;&nbsp; </td>
    <td onclick="filter_my_table('Debugging');" style="background:#aaffaa;font-weight:bold;font-size:30px;"> &nbsp;&nbsp;&nbsp;&nbsp; Debugging : {{ debugging_cnt|length }} &nbsp;&nbsp;&nbsp;&nbsp; </td>
    <td onclick="filter_my_table('sprint-ready');" style="background:#ffffaa;font-weight:bold;font-size:30px;"> &nbsp;&nbsp;&nbsp;&nbsp; sprint-ready : {{ ready_cnt|length }} &nbsp;&nbsp;&nbsp;&nbsp; </td>
    <td onclick="filter_my_table('Sprint-Accepted');" style="background:#ffaaaa;font-weight:bold;font-size:30px;"> &nbsp;&nbsp;&nbsp;&nbsp;Sprint-Accepted : {{ accepted_cnt|length }} &nbsp;&nbsp;&nbsp;&nbsp; </td>
</tr>
</tbody>
</table>
{% endif %}
<div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main" id='div_main'>
<form name="bugs_table_form" action="" id="bugs_table_form" method="post">
    <div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">
        <h1 class="page-header">
            <h2 class="sub-header">CPD - Kanban Status</h2>
        </h1>
<script>
function imgError(image) {
    image.onerror = "";
    image.src = "/static/images/avatar.png";
    return true;
}
</script>

<table id="bugs_table" class="display" cellspacing="5px" width="100%">
        <tbody width="100%">
        {% set prev_name = "" %}
        {% set cnt = 1 %}
        {% for entry in bugs %}
            {% if entry["assigned_rn"] != prev_name %}
                <tr style="background: #aaaaff; font-size: 50px;" width="100%">
                    <td /><td><img src=https://orgchart.vmware.com/employees/{{ entry["assigned_rn"] }}.jpg height="70" width="70" onerror="imgError(this);"/></td>
                    <td>{{ entry["assigned_rn"] }}</td>
                    {% set people_key = [] %}
                    {% for pk1 in people_list %}
                        {% if pk1 == entry["assigned_rn"] %}
                            {% if people_key.append(people_list[loop.index]) %} {% endif %}
                        {% endif %}
                    {% endfor %}
                    <td><font color="#aaaaff" size="0px" hidden="true">{{ people_key|join(',') }}</font></td>
                    <td /><td /><td /><td /><td /><td /><td /><td /><td />
                </tr>
                <tr style="font-weight:bold;background:#aaaaff;" width="100%">
                  <td>#</td>
                  <td>Bug ID</td>
                  <td>Summary</td>
                  <td>Kanban State</td>
                  <td>Weight</td>
                  <td>Priority</td>
                  <td>Severity</td>
                  <td>Case Count</td>
                  <td>Fix By</td>
                  <td>Assigned_to</td>
                  <td>ETA</td>
                  <td>Last Modified</td>
                  <td>Highlighted<br>Reasons</td>
                </tr>

            {% set cnt = 1 %}
            {% endif %}
            {% set kanban_state = "" %}
            {% if entry["keywords"].find("Sprint-Accepted") >= 0 %}
            <tr style="background:#ffaaaa;">
            {% set kanban_state = "Sprint-Accepted" %}
            {% elif entry["keywords"].find("sprint-ready") >= 0 %}
            <tr style="background:#ffffaa;">
            {% set kanban_state = "sprint-ready" %}
            {% elif entry["keywords"].find("Debugging") >= 0 %}
            <tr style="background:#aaffaa;">
            {% set kanban_state = "Debugging" %}
            {% elif actbugids.find(entry["bug_id"]|string) >= 0 %}
            <tr style="background:#444444;color:white;">
            {% set kanban_state = "Pending" %}
            {% else %}
            <tr>
            {% endif %}
                <td style="font-weight:bold;"> {{ cnt }} </td>
                <td><a href=https://bugzilla.eng.vmware.com/show_bug.cgi?id={{ entry["bug_id"] }} target="_blank">{{ entry["bug_id"] }}</a></td>
                <td>{{ entry["short_desc"] }}</td>
                <td style="font-weight:bold;" nowrap="nowrap">{{ kanban_state }}</td>
                <td style="color:red;font-weight:bold;">{{ entry["weight"] }}</td>
                <td>{{ entry["priority"] }}</td>
                <td>{{ entry["bug_severity"] }}</td>
                <td>{{ entry["case_count"] }}</td>
                
                <!--The following two scripts are implemented for auto-completion-->
                <td>
                    {% for fix_entry in fix_by[entry["bug_id"]] %}
                        <p> {{ fix_entry['product'] }} - {{ fix_entry['version'] }} - {{ fix_entry['phase'] }}
                    {% endfor %}
                </td>
                <td style="font-weight:bold;">{{ entry["assigned_rn"] }}</td>
                <td nowrap="nowrap">{{ entry["cf_eta"] }}</td>
                <td>{{ entry["delta_ts"] }}</td>
                <td>{{ entry["highlighted_by"] }}</td>
            </tr>
        {% set prev_name = entry["assigned_rn"] %}
        {% set cnt = cnt + 1 %}
        {% endfor %}
        </tbody>
    </table>
    <input type=hidden name= assigned_to value= {{assigned}}>
    <!-- <button id = "button" type = "submit">Submit</button> -->

    <style>
    .floating-button {position:fixed; z-index:9999; bottom:15px;width:78%;}
    </style>
    <!--<h3><button class="btn btn-lg btn-primary btn-block floating-button" type="submit" id="submit_button">Submit Change</button></h3>-->
    <br>
    <style>
    .mini-submenu{
      width: 1%;
      position:fixed; 
      z-index:9999; 
      top:50%;
      left:0px;
    }
    .mini-submenu-hide{
      width: 1%;
      position:fixed; 
      z-index:9999; 
      top:50%;
      left:16%;
      display:none;
    }
    </style>
    <br>
    </form>
    <h3><button class="btn btn-lg btn-primary btn-block mini-submenu" type='button'>-<br>-<br>-</button></h3>
    <h3><button class="btn btn-lg btn-primary btn-block mini-submenu-hide" type='button'><<br><<br><</button></h3>
</div>



<script>
$(function(){

    $('.mini-submenu').on('click',function(){       
        $('#div_sidebar').fadeIn('slide',function(){});
        $('.mini-submenu-hide').fadeIn('slide',function(){});
        $('.mini-submenu').hide();

/*
        e1 = document.getElementById("submit_button");
        e1.style.width = "75%";
*/
        $('.main').each(function(){
            this.style.width = "100%";
            this.style.marginLeft = "10%";
        })

    })

    $('.mini-submenu-hide').on('click',function(){       
        $('.mini-submenu-hide').hide();
        $('.mini-submenu').fadeIn('slide',function(){});

        $('#div_sidebar').fadeOut('slide',function(){});
/*
        e1 = document.getElementById("submit_button");
        e1.style.width = "90%";
        //e1.style.marginLeft = '0px';
*/
        $('.main').each(function(){
            this.style.width = "100%";
            this.style.marginLeft = '0px';
        })
    })

})
</script>
{% endblock %}
</body>
{% endif %}
