{% extends "layout.html" %}
{% if session.logged_in %}
<head>
{%block head%}
<link rel='stylesheet' type='text/css' href='static/css/dataTables.bootstrap.css'>
<link rel="stylesheet" type="text/css" href="static/css/jquery.dataTables.css">
<link rel="stylesheet" type="text/css" href="static/css/dataTables.colVis.css">
<script type='text/javascript' src='static/js/jquery-1.11.1.js'></script>
<script type='text/javascript' src='static/js/dataTables.bootstrap.js'></script>
<script type='text/javascript' src='static/js/bootstrap-3.1.1.js'></script>
<script type='text/javascript' src='static/js/jquery.dataTables.js'></script>
<script type='text/javascript' src='static/js/dataTables.colVis.js'></script>
<script type='text/javascript' src='static/js/dataTables.fixedColumns.js'></script>
<script type="text/javascript" src="static/js/dataTables.fnGetFilteredNodes.js"></script>
<script type="text/javascript" src="static/js/dataTables.fnGetHiddenNodes.js"></script>
<!--
When setting the name of posted variables, the name of "check_id", "comment_id" should not be assigned since I used the check_id to represent the checkboxes and comment_id to represent the comments
07/15/2014 ShinYeh
-->
<link rel="stylesheet" type="text/css" href="static/css/jquery-ui.css">
<script type='text/javascript' src='static/js/Chart.js'></script>
<script type='text/javascript' src='static/js/jquery-ui.js'></script>

<script>
/* Create an array with the values of all the input boxes in a column, parsed as numbers */
$.fn.dataTable.ext.order['dom-text-numeric'] = function  ( settings, col )
{
    return this.api().column( col, {order:'index'} ).nodes().map( function ( td, i ) {
        return $('input', td).val() * 1;
    } );
}

$.fn.dataTable.ext.order['dom-text'] = function  ( settings, col )
{
    return this.api().column( col, {order:'index'} ).nodes().map( function ( td, i ) {
        return $('input', td).val();
    } );
}
</script>


<script>
    $(function() {
        $(".search-product").autocomplete({
            source: "{{url_for("autocomplete_product")}}",
            minLength: 2
        });
    });
</script>

</style>

<script>    
var oTable;
$(document).ready(function() {
    $('#div_sidebar').fadeOut('slide',function(){});
/*
    e1 = document.getElementById("submit_button");
    e1.style.width = "90%";
    e1.style.marginLeft = 10;
*/
    $('.main').each(function(){
        this.style.width = "100%";
        this.style.marginLeft = 0;
    })

    var oTable = $('#bugs_table').DataTable({
        paging:         true, 
        "lengthMenu": [ [-1, 5, 10, 25, 50], ["All", 5, 10, 25, 50] ],
        dom: 'C<"clear">lfrtip',
        //scrollY:        "600px",
        //scrollX: true,
        "bSort":false,
        "aoColumns": [ 
            {"bVisible":true},  //Number
            {"bVisible":true},  //BugID
            {"bVisible":true},  //Summary-short_desc
            {"bVisible":true},  //Keywords
            {"bVisible":true},  //Weights
            {"bVisible":false}, //Priority
            {"bVisible":false}, //Severity
            {"bVisible":false}, //Case count
            {"bVisible":true, "sWidth":"20%", "orderDataType": "dom-text"},  //Fix_by_x
            {"bVisible":true},  //Assigned to
            {"bVisible":true},  //ETA
            {"bVisible":false},  //Last Modified
            {"bVisible":true},  //Highlighted Reasons
        ],
    } );

/*
    var oTable2 = $('#summary_table').DataTable({
        paging:         true,
        "lengthMenu": [ [-1, 5, 10, 25, 50], ["All", 5, 10, 25, 50] ],
        dom: 'C<"clear">lfrtip',
        //scrollY:        "600px",
        scrollX: true,
        "bSort":false,
        "aoColumns": [
            {"bVisible":true},  //Number
            {"bVisible":true},  //BugID
            {"bVisible":true},  //Summary-short_desc
        ],
    } );
*/

    /*$('form').submit( function () {

       //Loop through the TR records
       oTable.$("td").each(function(index, nRow,name){
            //Select the input from the row
            //var rowInput = $("input", nRow);
            //Select the text area from the row
            //var rowTextarea = $("textarea", nRow);

            //Add to form
            var nHidden = document.createElement( 'input' );
            nHidden.type = 'hidden';
            nHidden.name = "hidden_input_"+index+name;

            //Assuming there is one input per row
            nHidden.value = $("input", nRow).val();
            //alert(nHidden.value);
            $(".form").append( nHidden );
            console.log(nHidden);
        });
        return false;
        $(".form").submit();
        });*/
} );
</script>

<link rel="stylesheet" type="text/css" href="static/css/vis.css">
<script type="text/javascript" src="static/js/vis.js"></script>


{% endblock %}
</head>
<body>
{% block body%}
<div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main" id='div_main'>
<form name="bugs_table_form" action="" id="bugs_table_form" method="post">
    <div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">
        <h1 class="page-header">
            <h2 class="sub-header">CPD - Kanban Status</h2>
        </h1>

<table id="summary_table" align="right">
<tbody>
{% set debugging_cnt = [] %}
{% set ready_cnt = [] %}
{% set accepted_cnt = [] %}
{% set total_cnt = [] %}
<tr>
{% for entry in bugs %}
    {% if total_cnt.append(1) %} {% endif %}
    {% if entry["keywords"].find("Sprint-Accepted") >= 0 %}
        {% if accepted_cnt.append(1) %} {% endif %}
    {% elif entry["keywords"].find("sprint-ready") >= 0 %}
        {% if ready_cnt.append(1) %} {% endif %}
    {% elif entry["keywords"].find("Debugging") >= 0 %}
        {% if debugging_cnt.append(1) %} {% endif %}
    {% endif %}
{% endfor %}
    <td style="background:#000000;color:#ffffff;font-weight:bold;font-size:30px;"> &nbsp;&nbsp;&nbsp;&nbsp; Total : {{ total_cnt|length }} &nbsp;&nbsp;&nbsp;&nbsp; </td>
    <td style="background:#aaffaa;font-weight:bold;font-size:30px;"> &nbsp;&nbsp;&nbsp;&nbsp; Debugging : {{ debugging_cnt|length }} &nbsp;&nbsp;&nbsp;&nbsp; </td>
    <td style="background:#ffffaa;font-weight:bold;font-size:30px;"> &nbsp;&nbsp;&nbsp;&nbsp; sprint-ready : {{ ready_cnt|length }} &nbsp;&nbsp;&nbsp;&nbsp; </td>
    <td style="background:#ffaaaa;font-weight:bold;font-size:30px;"> &nbsp;&nbsp;&nbsp;&nbsp;Sprint-Accepted : {{ accepted_cnt|length }} &nbsp;&nbsp;&nbsp;&nbsp; </td>
</tr>
</tbody>
</table>
<br>
<br>
<br>
<br>

<script>
function imgError(image) {
    image.onerror = "";
    image.src = "/static/images/avatar.png";
    return true;
}
</script>

<table id="bugs_table" class="display" cellspacing="5px" width="100%">
        <tbody width="100%">
        {% set prev_name = "" %}
        {% set cnt = 1 %}
        {% for entry in bugs %}
            {% if entry["assigned_rn"] != prev_name %}
                <tr style="background: #aaaaff; font-size: 50px;" width="100%">
                    <td /><td><img src=https://orgchart.vmware.com/employees/{{ entry["assigned_rn"] }}.jpg height="70" width="70" onerror="imgError(this);"/></td>
                    <td>{{ entry["assigned_rn"] }}<font color="#aaaaff" size="0px" hidden="true">Debugging,Spring-Ready,Sprint-Accepted</font></td>
                    <td /><td /><td /><td /><td /><td /><td /><td /><td /><td />
                </tr>
                <tr style="font-weight:bold;background:#aaaaff;" width="100%">
                  <td>#</td>
                  <td>Bug ID</td>
                  <td>Summary</td>
                  <td>Kanban State</td>
                  <td>Weight</td>
                  <td>Priority</td>
                  <td>Severity</td>
                  <td>Case Count</td>
                  <td width=80%>fix by product-version-phase</td>
                  <td>Assigned_to</td>
                  <td>ETA</td>
                  <td>Last Modified</td>
                  <td>Highlighted Reasons</td>
                </tr>

            {% set cnt = 1 %}
            {% endif %}
            {% set kanban_state = "" %}
            {% if entry["keywords"].find("Sprint-Accepted") >= 0 %}
            <tr style="background:#ffaaaa;">
            {% set kanban_state = "Sprint-Accepted" %}
            {% elif entry["keywords"].find("sprint-ready") >= 0 %}
            <tr style="background:#ffffaa;">
            {% set kanban_state = "sprint-ready" %}
            {% elif entry["keywords"].find("Debugging") >= 0 %}
            <tr style="background:#aaffaa;">
            {% set kanban_state = "Debugging" %}
            {% else %}
            <tr>
            {% endif %}
                <td style="font-weight:bold;"> {{ cnt }} </td>
                <td><a href=https://bugzilla.eng.vmware.com/show_bug.cgi?id={{ entry["bug_id"] }} target="_blank">{{ entry["bug_id"] }}</a></td>
                <td>{{ entry["short_desc"] }}</td>
                <td style="font-weight:bold;">{{ kanban_state }}</td>
                <td style="color:red;font-weight:bold;">{{ entry["weight"] }}</td>
                <td>{{ entry["priority"] }}</td>
                <td>{{ entry["bug_severity"] }}</td>
                <td>{{ entry["case_count"] }}</td>
                
                <!--The following two scripts are implemented for auto-completion-->
                <td>
                    {% for fix_entry in fix_by[entry["bug_id"]] %}
                        <p> {{ fix_entry['product'] }} - {{ fix_entry['version'] }} - {{ fix_entry['phase'] }}
                    {% endfor %}
                </td>
                <td style="font-weight:bold;">{{ entry["assigned_rn"] }}</td>
                <td>{{ entry["cf_eta"] }}</td>
                <td>{{ entry["delta_ts"] }}</td>
                <td>{{ entry["highlighted_by"] }}</td>
            </tr>
        {% set prev_name = entry["assigned_rn"] %}
        {% set cnt = cnt + 1 %}
        {% endfor %}
        </tbody>
    </table>
    <input type=hidden name= assigned_to value= {{assigned}}>
    <!-- <button id = "button" type = "submit">Submit</button> -->

    <style>
    .floating-button {position:fixed; z-index:9999; bottom:15px;width:78%;}
    </style>
    <!--<h3><button class="btn btn-lg btn-primary btn-block floating-button" type="submit" id="submit_button">Submit Change</button></h3>-->
    <br>
    <style>
    .mini-submenu{
      width: 1%;
      position:fixed; 
      z-index:9999; 
      top:50%;
      left:0px;
    }
    .mini-submenu-hide{
      width: 1%;
      position:fixed; 
      z-index:9999; 
      top:50%;
      left:16%;
      display:none;
    }
    </style>
    <br>
    </form>
    <h3><button class="btn btn-lg btn-primary btn-block mini-submenu" type='button'>-<br>-<br>-</button></h3>
    <h3><button class="btn btn-lg btn-primary btn-block mini-submenu-hide" type='button'><<br><<br><</button></h3>
</div>



<script>
$(function(){

    $('.mini-submenu').on('click',function(){       
        $('#div_sidebar').fadeIn('slide',function(){});
        $('.mini-submenu-hide').fadeIn('slide',function(){});
        $('.mini-submenu').hide();

/*
        e1 = document.getElementById("submit_button");
        e1.style.width = "75%";
*/
        $('.main').each(function(){
            this.style.width = "100%";
            this.style.marginLeft = "10%";
        })

    })

    $('.mini-submenu-hide').on('click',function(){       
        $('.mini-submenu-hide').hide();
        $('.mini-submenu').fadeIn('slide',function(){});

        $('#div_sidebar').fadeOut('slide',function(){});
/*
        e1 = document.getElementById("submit_button");
        e1.style.width = "90%";
        //e1.style.marginLeft = '0px';
*/
        $('.main').each(function(){
            this.style.width = "100%";
            this.style.marginLeft = '0px';
        })
    })

})
</script>
{% endblock %}
</body>
{% endif %}
